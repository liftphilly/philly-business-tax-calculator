<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFT Calculator Test Results</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        .header {
            background: #0f172a;
            color: white;
            padding: 16px 20px;
            text-align: center;
        }
        .header h1 { font-size: 1.25rem; margin-bottom: 4px; }
        .header p { font-size: 0.85rem; opacity: 0.7; }

        .nav-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: white;
            border-bottom: 1px solid #e5e7eb;
        }

        .nav-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid #0f172a;
            background: white;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .nav-btn:hover { background: #0f172a; color: white; }
        .nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .nav-btn:disabled:hover { background: white; color: #0f172a; }

        .scenario-indicator {
            font-size: 1rem;
            font-weight: 600;
            color: #0f172a;
            min-width: 100px;
            text-align: center;
        }

        .scenario-dots {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 8px;
        }
        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #d1d5db;
            cursor: pointer;
            transition: all 0.2s;
        }
        .dot.active { background: #fbbf24; transform: scale(1.3); }
        .dot:hover { background: #9ca3af; }

        .scenarios-container {
            overflow: hidden;
            position: relative;
        }

        .scenarios-track {
            display: flex;
            transition: transform 0.3s ease-out;
        }

        .scenario {
            min-width: 100%;
            padding: 20px;
        }

        .scenario-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            overflow: hidden;
            max-width: 600px;
            margin: 0 auto;
        }

        .scenario-header {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .scenario-header h2 { font-size: 1.1rem; margin-bottom: 8px; }
        .params {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }
        .param {
            background: rgba(255,255,255,0.15);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .scenario-content { padding: 20px; }

        .screenshot {
            width: 100%;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            margin-top: 12px;
        }

        .summary {
            margin-top: 20px;
            padding: 16px;
            background: #fef3c7;
            border-radius: 12px;
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        .summary-row:last-child { border-bottom: none; }
        .summary-label { font-weight: 500; color: #92400e; font-size: 0.9rem; }
        .summary-value { font-weight: 700; color: #0f172a; font-size: 1.1rem; }
        .negative { color: #dc2626; }

        .csv-link {
            display: block;
            margin-top: 16px;
            padding: 14px 20px;
            background: #fbbf24;
            color: #0f172a;
            text-decoration: none;
            border-radius: 10px;
            font-weight: 600;
            text-align: center;
            font-size: 1rem;
        }
        .csv-link:hover { background: #f59e0b; }

        /* Flowchart */
        .flowchart-toggle {
            display: block;
            width: 100%;
            margin-top: 12px;
            padding: 10px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #475569;
            font-size: 0.85rem;
        }
        .flowchart-toggle:hover { background: #e2e8f0; }
        .flowchart {
            display: block;
            margin-top: 12px;
            padding: 16px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            font-size: 0.8rem;
            line-height: 1.6;
            position: relative;
        }
        .flowchart.hidden { display: none; }
        .flowchart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #fbbf24;
            padding-bottom: 10px;
            margin-bottom: 12px;
        }
        .flowchart-title {
            margin: 0;
            color: #0f172a;
            font-size: 1rem;
            font-weight: 600;
        }
        .export-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: #0f172a;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            white-space: nowrap;
        }
        .export-btn:hover { background: #1e293b; }
        .flowchart h4 {
            margin: 0 0 8px 0;
            color: #0f172a;
            font-size: 0.9rem;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 6px;
        }
        .flowchart-step {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 4px 8px;
            margin: 8px 0;
            padding: 6px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        .flowchart-step:last-of-type { border-bottom: none; }
        .flowchart-step .label {
            color: #64748b;
            font-size: 0.75rem;
            grid-column: 1 / -1;
        }
        .flowchart-step .formula {
            color: #475569;
            font-family: monospace;
            font-size: 0.8rem;
        }
        .flowchart-step .value {
            font-weight: 700;
            color: #0f172a;
            text-align: right;
            font-size: 0.9rem;
        }
        .flowchart-divider {
            border-top: 1px dashed #cbd5e1;
            margin: 10px 0;
        }
        .flowchart-result {
            background: #fef2f2;
            padding: 8px;
            margin: 8px -8px;
            border-radius: 6px;
        }
        .flowchart-result .label {
            font-weight: 600;
            color: #dc2626;
        }
        .flowchart-result .value {
            color: #dc2626;
            font-size: 1rem;
        }
        .flowchart-note {
            font-style: italic;
            color: #94a3b8;
            font-size: 0.75rem;
            margin-top: 8px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            cursor: pointer;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
        }
        .modal img {
            display: block;
            width: 100%;
            max-width: 1200px;
            margin: 20px auto;
        }
        .modal.active { display: block; }
        .modal-close {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 44px;
            height: 44px;
            background: white;
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 1001;
        }

        /* Swipe hint on mobile */
        .swipe-hint {
            text-align: center;
            padding: 12px;
            color: #64748b;
            font-size: 0.85rem;
        }

        /* Comparison table */
        .comparison-section {
            padding: 20px;
            background: white;
            border-bottom: 1px solid #e5e7eb;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        .comparison-table th {
            background: #f1f5f9;
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            color: #475569;
            border-bottom: 2px solid #e2e8f0;
        }
        .comparison-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #e5e7eb;
        }
        .comparison-table tr:hover { background: #fef3c7; cursor: pointer; }
        .comparison-table .negative { color: #dc2626; font-weight: 700; }

        @media (min-width: 768px) {
            .swipe-hint { display: none; }
            .scenario { padding: 40px; }
            .comparison-table { font-size: 0.95rem; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>LIFT Calculator Test Results</h1>
        <p>Review scenarios for accuracy</p>
    </div>

    <div class="comparison-section">
        <table class="comparison-table" id="comparison-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Start</th>
                    <th>Gross</th>
                    <th>Net</th>
                    <th>Annual ‚Üë</th>
                    <th>Shock ‚Üë</th>
                    <th>Shock Yr</th>
                    <th>Type</th>
                </tr>
            </thead>
            <tbody id="comparison-tbody">
                <!-- Dynamically generated -->
            </tbody>
        </table>
    </div>

    <div class="nav-controls">
        <button class="nav-btn" id="prev-btn" onclick="navigate(-1)">&#8592;</button>
        <div>
            <div class="scenario-indicator" id="indicator">Scenario 1 of 6</div>
            <div class="scenario-dots" id="dots"></div>
        </div>
        <button class="nav-btn" id="next-btn" onclick="navigate(1)">&#8594;</button>
    </div>

    <div class="swipe-hint">Swipe left/right or use arrows</div>

    <div class="scenarios-container" id="container">
        <div class="scenarios-track" id="track">
            <!-- Dynamically generated -->
        </div>
    </div>

    <div class="modal" id="modal">
        <button class="modal-close" onclick="hideModal()">&times;</button>
        <img id="modal-img" src="" alt="Full size screenshot">
    </div>

    <!-- Load shared tax calculator -->
    <script src="/calculator/tax-calculator.js"></script>

    <script>
        // Test scenarios - change these and the flowcharts update automatically
        const SCENARIOS = [
            { id: 1, startYear: 2022, grossReceipts: 50000, netIncome: 50000 },
            { id: 2, startYear: 2022, grossReceipts: 110000, netIncome: 50000 },
            { id: 3, startYear: 2023, grossReceipts: 50000, netIncome: 50000 },
            { id: 4, startYear: 2023, grossReceipts: 110000, netIncome: 50000 },
            { id: 5, startYear: 2024, grossReceipts: 110000, netIncome: 50000 },
            { id: 6, startYear: 2024, grossReceipts: 50000, netIncome: 50000 }
        ];

        const { formatCurrency, calculateTaxLiability, calculateShockIncrease, generateFlowchartHTML } = window.TaxCalculator;

        // Calculate summary values for a scenario
        function calculateScenarioSummary(scenario) {
            const tax2024 = calculateTaxLiability(scenario.netIncome, scenario.grossReceipts, 2024, true);
            const tax2025 = calculateTaxLiability(scenario.netIncome, scenario.grossReceipts, 2025, true);

            const annualIncrease = tax2025.totalTax - tax2024.totalTax;

            // Calculate shock increase using the same logic as the main calculator
            const shockResult = calculateShockIncrease(scenario.netIncome, scenario.grossReceipts, scenario.startYear);

            return {
                annualIncrease,
                shockIncrease: shockResult.shockIncrease,
                shockYear: shockResult.shockYear,
                shockType: shockResult.shockType,
                cashShock: shockResult.cashShock,
                workingCashShock: shockResult.workingCashShock
            };
        }

        // Generate comparison table
        function generateComparisonTable() {
            const tbody = document.getElementById('comparison-tbody');
            tbody.innerHTML = SCENARIOS.map((s, i) => {
                const summary = calculateScenarioSummary(s);
                return `
                    <tr onclick="goTo(${i})">
                        <td>${s.id}</td>
                        <td>${s.startYear}</td>
                        <td>$${s.grossReceipts / 1000}k</td>
                        <td>$${s.netIncome / 1000}k</td>
                        <td>‚Üë${formatCurrency(summary.annualIncrease)}</td>
                        <td class="negative">‚Üë${formatCurrency(summary.shockIncrease)}</td>
                        <td>${summary.shockYear}</td>
                        <td>${summary.shockType === 'cash' ? 'üí∞ Cash' : 'üè¶ Working'}</td>
                    </tr>
                `;
            }).join('');
        }

        // Generate scenario cards
        function generateScenarioCards() {
            const track = document.getElementById('track');
            track.innerHTML = SCENARIOS.map(s => {
                const summary = calculateScenarioSummary(s);
                const flowchartHTML = generateFlowchartHTML(s.grossReceipts, s.netIncome, 2024, 2025, s.startYear);

                return `
                    <div class="scenario">
                        <div class="scenario-card">
                            <div class="scenario-header">
                                <h2>Scenario ${s.id}</h2>
                                <div class="params">
                                    <span class="param">Start Year: ${s.startYear}</span>
                                    <span class="param">Gross: ${formatCurrency(s.grossReceipts)}</span>
                                    <span class="param">Net: ${formatCurrency(s.netIncome)}</span>
                                </div>
                            </div>
                            <div class="scenario-content">
                                <div class="summary">
                                    <div class="summary-row">
                                        <span class="summary-label">Annual Tax Increase</span>
                                        <span class="summary-value">+${formatCurrency(summary.annualIncrease)}</span>
                                    </div>
                                    <div class="summary-row">
                                        <span class="summary-label">${summary.shockType === 'cash' ? 'Shock Year Tax Increase' : 'Shock Year BIRT Est. Payment Increase'} (April ${summary.shockYear})</span>
                                        <span class="summary-value negative">+${formatCurrency(summary.shockIncrease)}</span>
                                    </div>
                                    <div class="summary-row" style="font-size: 0.85rem; opacity: 0.8;">
                                        <span class="summary-label">Shock Type</span>
                                        <span class="summary-value">${summary.shockType === 'cash' ? 'üí∞ Cash Shock' : 'üè¶ Working Cash Shock'}</span>
                                    </div>
                                </div>
                                <button class="flowchart-toggle" onclick="toggleFlowchart(${s.id})">Hide Calculation Breakdown</button>
                                <div class="flowchart" id="flowchart-${s.id}">
                                    <div class="flowchart-header">
                                        <span class="flowchart-title">üìä Annual Tax Increase Calculation</span>
                                        <button class="export-btn" onclick="exportCSV(${s.id})">üìÑ Export CSV</button>
                                    </div>
                                    ${flowchartHTML}
                                </div>
                                <img src="scenario_${s.id}.png" alt="Scenario ${s.id}" class="screenshot" onclick="showModal(this.src)">
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Initialize page
        generateComparisonTable();
        generateScenarioCards();

        // Navigation
        const total = SCENARIOS.length;
        let current = 0;
        const track = document.getElementById('track');
        const indicator = document.getElementById('indicator');
        const dotsContainer = document.getElementById('dots');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');

        // Create dots
        for (let i = 0; i < total; i++) {
            const dot = document.createElement('div');
            dot.className = 'dot' + (i === 0 ? ' active' : '');
            dot.onclick = () => goTo(i);
            dotsContainer.appendChild(dot);
        }

        function updateUI() {
            track.style.transform = `translateX(-${current * 100}%)`;
            indicator.textContent = `Scenario ${current + 1} of ${total}`;
            prevBtn.disabled = current === 0;
            nextBtn.disabled = current === total - 1;

            document.querySelectorAll('.dot').forEach((dot, i) => {
                dot.className = 'dot' + (i === current ? ' active' : '');
            });
        }

        function navigate(dir) {
            const next = current + dir;
            if (next >= 0 && next < total) {
                current = next;
                updateUI();
            }
        }

        function goTo(index) {
            current = index;
            updateUI();
        }

        function toggleFlowchart(num) {
            const flowchart = document.getElementById('flowchart-' + num);
            const btn = event.target;
            flowchart.classList.toggle('hidden');
            btn.textContent = flowchart.classList.contains('hidden') ? 'Show Calculation Breakdown' : 'Hide Calculation Breakdown';
        }

        // Generate and download CSV for a scenario
        function exportCSV(scenarioId) {
            const s = SCENARIOS.find(x => x.id === scenarioId);
            if (!s) return;

            const { calculateTaxLiability, calculateShockIncrease, TAX_RATES, EXEMPTION_BY_YEAR } = window.TaxCalculator;

            const tax2024 = calculateTaxLiability(s.netIncome, s.grossReceipts, 2024, true);
            const tax2025 = calculateTaxLiability(s.netIncome, s.grossReceipts, 2025, true);
            const shockResult = calculateShockIncrease(s.netIncome, s.grossReceipts, s.startYear);

            const rows = [
                ['LIFT Tax Calculator - Scenario ' + s.id],
                [''],
                ['Parameters'],
                ['Start Year', s.startYear],
                ['Gross Receipts', s.grossReceipts],
                ['Net Income', s.netIncome],
                [''],
                ['2024 Tax Calculation (With $100K Exemption)'],
                ['Taxable Gross Receipts', `=MAX(0, ${s.grossReceipts} - 100000)`, tax2024.taxableGR],
                ['Taxable Net Income (BIRT)', '', tax2024.taxableNI_BIRT],
                ['Taxable Net Income (NPT)', s.netIncome, tax2024.taxableNI_NPT],
                ['BIRT (GR)', `=${tax2024.taxableGR} * ${TAX_RATES[2024].birtGR}`, tax2024.birtGR],
                ['BIRT (NI)', `=${tax2024.taxableNI_BIRT} * ${TAX_RATES[2024].birtNI}`, tax2024.birtNI],
                ['Total BIRT', `=${tax2024.birtGR} + ${tax2024.birtNI}`, tax2024.birtTotal],
                ['NPT (before credit)', `=${s.netIncome} * ${TAX_RATES[2024].npt}`, tax2024.nptGross],
                ['BIRT Credit (60%)', `=${tax2024.birtNI} * 0.6`, tax2024.birtCredit],
                ['NPT (after credit)', `=MAX(0, ${tax2024.nptGross} - ${tax2024.birtCredit})`, tax2024.nptAfterCredit],
                ['Total Tax 2024', `=${tax2024.birtTotal} + ${tax2024.nptAfterCredit}`, tax2024.totalTax],
                [''],
                ['2025 Tax Calculation (No Exemption)'],
                ['Taxable Gross Receipts', s.grossReceipts, tax2025.taxableGR],
                ['Taxable Net Income (BIRT)', s.netIncome, tax2025.taxableNI_BIRT],
                ['Taxable Net Income (NPT)', s.netIncome, tax2025.taxableNI_NPT],
                ['BIRT (GR)', `=${tax2025.taxableGR} * ${TAX_RATES[2025].birtGR}`, tax2025.birtGR],
                ['BIRT (NI)', `=${tax2025.taxableNI_BIRT} * ${TAX_RATES[2025].birtNI}`, tax2025.birtNI],
                ['Total BIRT', `=${tax2025.birtGR} + ${tax2025.birtNI}`, tax2025.birtTotal],
                ['NPT (before credit)', `=${s.netIncome} * ${TAX_RATES[2025].npt}`, tax2025.nptGross],
                ['BIRT Credit (60%)', `=${tax2025.birtNI} * 0.6`, tax2025.birtCredit],
                ['NPT (after credit)', `=MAX(0, ${tax2025.nptGross} - ${tax2025.birtCredit})`, tax2025.nptAfterCredit],
                ['Total Tax 2025', `=${tax2025.birtTotal} + ${tax2025.nptAfterCredit}`, tax2025.totalTax],
                [''],
                ['Summary'],
                ['Annual Tax Increase', `=${tax2025.totalTax} - ${tax2024.totalTax}`, tax2025.totalTax - tax2024.totalTax],
                ['Shock Year', shockResult.shockYear],
                ['Shock Year Increase', '', shockResult.shockIncrease]
            ];

            const csv = rows.map(row => row.map(cell => {
                const str = String(cell);
                return str.includes(',') || str.includes('"') ? `"${str.replace(/"/g, '""')}"` : str;
            }).join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `scenario_${s.id}_calculations.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Swipe support
        let touchStartX = 0;
        let touchEndX = 0;

        document.getElementById('container').addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        }, { passive: true });

        document.getElementById('container').addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            const diff = touchStartX - touchEndX;
            if (Math.abs(diff) > 50) {
                navigate(diff > 0 ? 1 : -1);
            }
        }, { passive: true });

        // Keyboard nav
        document.addEventListener('keydown', e => {
            if (e.key === 'ArrowLeft') navigate(-1);
            if (e.key === 'ArrowRight') navigate(1);
            if (e.key === 'Escape') hideModal();
        });

        // Modal
        function showModal(src) {
            document.getElementById('modal-img').src = src;
            document.getElementById('modal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function hideModal() {
            document.getElementById('modal').classList.remove('active');
            document.body.style.overflow = '';
        }

        document.getElementById('modal').addEventListener('click', e => {
            if (e.target === document.getElementById('modal')) hideModal();
        });
    </script>
</body>
</html>
